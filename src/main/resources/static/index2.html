<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <title>Log Axtarış Sistemi</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        select, input, button { margin: 5px; padding: 6px; }
        #results {
            margin-top: 20px;
            white-space: pre-wrap;
            background: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            line-height: 1.4em;
            max-height: 600px;
            overflow-y: auto;
        }
        .thread { color: black; font-weight: bold; }
        .req { color: green; font-weight: bold; }
        .res { color: red; font-weight: bold; }
        .thread-separator { height: 10px; border-bottom: 2px dashed #999; margin: 5px 0; }
        #loadingIndicator { text-align: center; margin: 10px 0; font-style: italic; color: #555; }
    </style>
</head>
<body>
<h2>Log Fayllarında Axtarış</h2>

<label for="logFiles">Log fayl seç:</label>
<select id="logFiles"></select><br>

<label for="uniqueData">Axtarış üçün unikal data daxil et:</label>
<input type="text" id="uniqueData" placeholder="Məs: T00034407" size="40">
<button onclick="fetchLog()">Axtar</button>

<div id="results"></div>

<script>
    // Global dəyişənlər
    let page = 0;
    const size = 50;
    let loading = false;
    let noMoreData = false;
    let currentFile = '';
    let currentUniqueData = '';
    const resultsDiv = document.getElementById("results");

    // Faylları serverdən alıb select-ə doldur
    async function loadFiles() {
        try {
            let response = await fetch("http://localhost:8080/api/filter/files");
            let files = await response.json();
            let select = document.getElementById("logFiles");

            files.forEach(file => {
                let option = document.createElement("option");
                option.value = file;
                option.textContent = file;
                select.appendChild(option);
            });
        } catch (err) {
            console.error("Faylları yükləmək mümkün olmadı", err);
        }
    }

    // Log sətirlərini rənglə və thread dəyişəndə separator qoy
    function highlightLogs(logs) {
        let lastThread = null;
        let result = [];

        logs.forEach(line => {
            let match = line.match(/\[(T\d+)\]/);
            let currentThread = match ? match[1] : null;

            if (lastThread && currentThread && lastThread !== currentThread) {
                result.push('<div class="thread-separator"></div>');
            }
            lastThread = currentThread;

            let highlighted = line
                .replace(/\[(T\d+)\]/g, '<span class="thread">[$1]</span>')
                .replace(/REQ:/g, '<span class="req">REQ:</span>')
                .replace(/RES:/g, '<span class="res">RES:</span>');

            result.push(highlighted);
        });

        return result.join("<br>");
    }

    // Scroll event: aşağıya çatanda daha çox log yüklə
    resultsDiv.addEventListener('scroll', () => {
        if (loading || noMoreData) return;
        if (resultsDiv.scrollTop + resultsDiv.clientHeight >= resultsDiv.scrollHeight - 50) {
            loadMoreLogs();
        }
    });

    // Daha çox log yüklə
    async function loadMoreLogs() {
        if (!currentFile || !currentUniqueData) return;
        loading = true;

        let loadingDiv = document.createElement('div');
        loadingDiv.id = 'loadingIndicator';
        loadingDiv.textContent = 'Yüklənir...';
        resultsDiv.appendChild(loadingDiv);

        try {
            let response = await fetch(`http://localhost:8080/api/filter/${currentFile}/${currentUniqueData}?page=${page}&size=${size}`);
            if (!response.ok) throw new Error('Xəta baş verdi');

            let logs = await response.json();
            if (logs.length === 0) {
                noMoreData = true;
            } else {
                resultsDiv.innerHTML = resultsDiv.innerHTML.replace('Yüklənir...', '') + highlightLogs(logs);
                page++;
            }
        } catch (err) {
            console.error(err);
            alert("Serverdən logları yükləmək mümkün olmadı!");
        } finally {
            loading = false;
            let indicator = document.getElementById('loadingIndicator');
            if (indicator) indicator.remove();
        }
    }

    // Axtarış düyməsi ilə yeni logları yüklə
    async function fetchLog() {
        currentFile = document.getElementById("logFiles").value;
        currentUniqueData = document.getElementById("uniqueData").value.trim();
        resultsDiv.innerHTML = '';

        if (!currentFile || currentUniqueData.length < 3) {
            resultsDiv.innerHTML = "Zəhmət olmasa fayl seçin və 3-dən çox simvol olan axtarış data daxil edin.";
            return;
        }

        page = 0;
        noMoreData = false;
        await loadMoreLogs();
    }

    // Səhifə açılanda faylları yüklə
    window.onload = loadFiles;
</script>
</body>
</html>
